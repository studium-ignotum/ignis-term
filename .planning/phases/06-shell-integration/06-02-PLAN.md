---
phase: 06-shell-integration
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - shell-integration/install.sh
  - shell-integration/README.md
autonomous: false

must_haves:
  truths:
    - "Running install.sh creates ~/.terminal-remote/ with init scripts"
    - "README explains how to add source line to shell rc file"
    - "Session appears in mac-client when shell is opened with integration"
    - "Shell exits cleanly and session disappears from mac-client"
  artifacts:
    - path: "shell-integration/install.sh"
      provides: "Installation script"
      min_lines: 20
      contains: "~/.terminal-remote"
    - path: "shell-integration/README.md"
      provides: "Usage documentation"
      min_lines: 30
      contains: "source ~/.terminal-remote"
  key_links:
    - from: "shell-integration/install.sh"
      to: "~/.terminal-remote/"
      via: "mkdir and cp commands"
      pattern: "mkdir.*terminal-remote"
---

<objective>
Create installation script and documentation for shell integration, then verify end-to-end functionality with mac-client.

Purpose: Make shell integration easy to install and verify it works with the complete pipeline before Phase 7.

Output: Install script, README, and verified integration with mac-client.
</objective>

<execution_context>
@/Users/nat/.claude/get-shit-done/workflows/execute-plan.md
@/Users/nat/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-shell-integration/06-CONTEXT.md
@.planning/phases/06-shell-integration/06-01-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create installation script and README</name>
  <files>shell-integration/install.sh, shell-integration/README.md</files>
  <action>
**Create shell-integration/install.sh:**

```bash
#!/bin/bash
# Terminal Remote Shell Integration Installer
# Installs init scripts to ~/.terminal-remote/

set -e

INSTALL_DIR="$HOME/.terminal-remote"
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"

echo "Installing Terminal Remote shell integration..."

# Create installation directory
mkdir -p "$INSTALL_DIR"

# Copy init scripts
cp "$SCRIPT_DIR/init.zsh" "$INSTALL_DIR/"
cp "$SCRIPT_DIR/init.bash" "$INSTALL_DIR/"
cp "$SCRIPT_DIR/init.fish" "$INSTALL_DIR/"

echo "Installed to $INSTALL_DIR/"
echo ""
echo "Add to your shell configuration:"
echo ""
echo "  Zsh (~/.zshrc):"
echo "    source ~/.terminal-remote/init.zsh"
echo ""
echo "  Bash (~/.bashrc):"
echo "    source ~/.terminal-remote/init.bash"
echo ""
echo "  Fish (~/.config/fish/config.fish):"
echo "    source ~/.terminal-remote/init.fish"
echo ""
echo "Note: Add the source line at the END of your rc file"
echo "      (after oh-my-zsh, starship, or other prompt tools)"
```

Make executable: `chmod +x shell-integration/install.sh`

**Create shell-integration/README.md:**

Content should include:
1. **What this does** - One paragraph explaining shell integration
2. **Installation** - Run install.sh, add source line
3. **Shell configuration examples** - Exact lines to add for zsh/bash/fish
4. **Important notes:**
   - Source at END of rc file (after prompt tools)
   - Requires mac-client running for sessions to appear
   - Works with any terminal app
5. **Troubleshooting:**
   - "Not connected" - mac-client not running
   - Check socket exists: `ls -la /tmp/terminal-remote.sock`
   - Verify installation: `ls ~/.terminal-remote/`
  </action>
  <verify>
`ls -la shell-integration/install.sh` shows executable permissions

`head -5 shell-integration/README.md` shows title and description

`grep -c "source.*terminal-remote" shell-integration/README.md` returns 3 (one per shell)
  </verify>
  <done>
install.sh is executable and copies scripts to ~/.terminal-remote/. README documents installation and usage for all three shells.
  </done>
</task>

<task type="auto">
  <name>Task 2: Test installation and script loading</name>
  <files></files>
  <action>
Run the installation and verify scripts load correctly:

1. **Run installer:**
   ```bash
   cd shell-integration && ./install.sh
   ```

2. **Verify installation:**
   ```bash
   ls -la ~/.terminal-remote/
   # Should show init.zsh, init.bash, init.fish
   ```

3. **Test each shell loads script without errors:**
   ```bash
   # Zsh
   zsh -c 'source ~/.terminal-remote/init.zsh && echo "zsh: OK"'

   # Bash
   bash --norc -c 'source ~/.terminal-remote/init.bash && echo "bash: OK"'

   # Fish
   fish -c 'source ~/.terminal-remote/init.fish && echo "fish: OK"'
   ```

4. **Verify fast startup when no mac-client:**
   ```bash
   # Ensure socket doesn't exist
   rm -f /tmp/terminal-remote.sock

   # Time zsh startup
   time zsh -c 'source ~/.terminal-remote/init.zsh'
   # Should complete in <100ms
   ```

Report any errors and fix scripts if needed.
  </action>
  <verify>
All three test commands print "OK" without errors.

Timing shows <100ms for script sourcing when mac-client not running.
  </verify>
  <done>
Scripts installed to ~/.terminal-remote/ and load without errors in all three shells. Fast startup confirmed.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Shell integration scripts that connect terminal sessions to mac-client. When sourced in a shell, the script:
1. Checks if mac-client is running (socket exists)
2. Sends registration JSON with session name and PID
3. Maintains connection so session stays active
4. Cleans up on shell exit
  </what-built>
  <how-to-verify>
**Test 1: Session appears in mac-client**

1. Start mac-client:
   ```bash
   cd mac-client && cargo run
   ```
   (Leave running in background or a separate terminal)

2. Open a NEW terminal window/tab (so shell sources the init script)

3. Check mac-client menu bar:
   - Click the tray icon
   - Should show "1 session" or session count

**Test 2: Session name is correct**

1. In the new terminal, check PWD:
   ```bash
   pwd  # Note the directory name
   echo $$  # Note the PID
   ```

2. Session name in mac-client logs should be "dirname [PID]"
   (Check terminal running cargo run for log output)

**Test 3: Clean disconnect on exit**

1. In the terminal with integration, type `exit`
2. Mac-client should show session disconnected in logs
3. Session count should decrease

**Test 4: No errors when mac-client not running**

1. Stop mac-client (Ctrl+C)
2. Open a NEW terminal
3. Should see no errors, shell starts normally
4. Startup should feel instant (no delay)

**Test 5: Works with your prompt theme**

1. If you use starship, p10k, or oh-my-zsh, verify:
   - Prompt still looks correct
   - No error messages about hooks
   - No perceptible delay
  </how-to-verify>
  <resume-signal>
Type "approved" if all tests pass, or describe any issues found.
  </resume-signal>
</task>

</tasks>

<verification>
Phase 6 requirements coverage:

- [x] SHELL-01: Auto-connect when shell starts - init scripts connect on source
- [x] SHELL-02: Zsh integration works - init.zsh with add-zsh-hook
- [x] SHELL-03: Bash integration works - init.bash with PROMPT_COMMAND pattern
- [x] SHELL-04: Silent no-op when mac-client not running - socket check returns immediately
- [x] SHELL-05: No prompt interference - uses proper hooks, no PS1 modification
- [x] SHELL-06: No perceptible delay - socket check is instant, connection is background
- [x] SHELL-07: Works in any terminal app - pure shell scripts, no terminal-specific code
- [x] SHELL-08: Session named from working directory - "dirname [PID]" format
- [x] SHELL-09: Graceful disconnect on shell exit - zshexit/trap/fish_exit handlers
</verification>

<success_criteria>
1. install.sh creates ~/.terminal-remote/ with all three init scripts
2. README documents installation for zsh, bash, and fish
3. Scripts load without errors in each shell
4. Human verification confirms:
   - Sessions appear in mac-client
   - Session names are correct
   - Clean disconnect on exit
   - No delay when mac-client not running
   - Works with prompt themes
</success_criteria>

<output>
After completion, create `.planning/phases/06-shell-integration/06-02-SUMMARY.md`
</output>
